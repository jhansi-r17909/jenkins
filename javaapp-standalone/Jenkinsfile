pipeline {
    agent any

    tools {
        maven 'Maven'
    }

    environment {
        PROJECT_DIR = "javaapp-standalone"
        DEPLOY_DIR = "/opt/myapp"
    }

    stages {

        stage('Checkout') {
            when {
                branch 'main'   // checkout only on main
            }
            steps {
                checkout scm
            }
        }

        stage('Build') {
            when {
                branch 'main'   // build only on main
            }
            steps {
                dir("${PROJECT_DIR}") {
                    sh "mvn clean package"
                }
            }
        }

        stage('Test') {
            when {
                branch 'dev'    // test only on dev
            }
            steps {
                dir("${PROJECT_DIR}") {
                    sh "mvn test"
                }
            }
        }

        stage('Sonar Scan') {
            when {
                branch 'dev'    // scan only on dev
            }
            steps {
                withSonarQubeEnv('sonarqube') {
                    dir("${PROJECT_DIR}") {
                        sh "mvn sonar:sonar"
                    }
                }
            }
        }

        stage('Deploy') {
            when {
                branch 'main'   // deploy only on main
            }
            steps {
                script {
                    sh """
                        echo 'Deploying artifact'
                        sudo mkdir -p ${DEPLOY_DIR}
                        sudo cp ${PROJECT_DIR}/target/*.jar ${DEPLOY_DIR}/
                    """
                }
                echo "Deployment to ${DEPLOY_DIR} completed"
            }
        }
    }

    post {
        success {
            echo "SUCCESS → Branch: ${env.BRANCH_NAME}"
        }
        failure {
            echo "FAILED → Branch: ${env.BRANCH_NAME}"
        }
    }
}
